<!DOCTYPE html>
<html>
  <head onload="losa()">
    <title>N G S</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <script type="text/javascript" src="prototype.js"></script>

    <script type="text/javascript">

        const SelFile = document.getElementById("fc");

        var myStorage = sessionStorage;

        function eventFire(el, etype){
            if (el.fireEvent) {
                el.fireEvent('on' + etype);
            } else {
                var evObj = document.createEvent('Events');
                evObj.initEvent(etype, true, false);
                el.dispatchEvent(evObj);
            }
        }

        function clicks() {$('uriForm#databaseActionForm').submit();}//document.getElementById('sendForm').getElementsByClassName('cl')[0].databaseActionForm.submit();}

        var LOS = false;

        var LOH = 0;

        var UNS = 0;

        document.observe("dom:loaded", function() {
            function log(text) {
                //(new Date).getTime()
                var newSpan = document.createElement('log');
                $("log").innerHTML = tif()+ ": " + (!Object.isUndefined(text) && text !== null ? text.escapeHTML() : "null") + $("log").innerHTML;
            }

            function error(text) {
                //(new Date).getTime()
                var ta = document.getElementById('log');
                LOH+=1;
                var ns = document.createElement('log' + LOH);
                ns.style.color="black";
                //$("log")
                ns.innerHTML = tif()+ ": " + (!Object.isUndefined(text) && text !== null ? text.escapeHTML() : "null") + $("log").innerHTML;
            }

            if (!window.WebSocket) {
                alert("FATAL: WebSocket not natively supported. This demo will not work!");
            }

            var ws;

            var usn;

            var bool = false;

            $("uriForm").observe("submit", function(e) {
                e.stop();
                ws = new WebSocket($F("uri"));
                usn = document.getElementById('un');
                UNS=usn.value.replace("\n", "");
                myStorage.setItem('un', UNS);
                if (usn.value === "") {usn.value="Default Name";}
                ws.onopen = function() {
                    if (ws) {
                        ws.send("Username\n" + UNS);
                        log("[Status] Connected to '" + $F("uri") + "' with the username : '" + UNS + "'\n");
                        bool=true;
                    }
                }
                ws.onmessage = function(e) {
                    var LPD = e.data.split("\n", 4);
                    if (LPD.length==4) {
                        if (LPD[0].toUpperCase()==("Username".toUpperCase())&&LPD[2].toUpperCase()==("Text".toUpperCase())) {
                            log("["+LPD[1]+"] : " + LPD[3] + "\n");
                        }
                    }
                    var LPD2 = e.data.split("\n", 2);

                    if (LPD2.length==2) {if(LPD2[0].toUpperCase()==("Leave".toUpperCase())){log("[Status] "+LPD2[1]+" has left the chat\n");}}

                    if (LPD2.length==2) {if(LPD2[0].toUpperCase()==("Join".toUpperCase())){log("[Status] "+LPD2[1]+" has joined the chat\n");}}
                }
                ws.onclose = function() {
                    log("[Status] Disconnected from the server\n");
                    $("uri", "connect").invoke("enable");
                    $("disconnect").disable();
                    usn.enable();
                    ws = null;
                }
                usn.disable();
                $("uri", "connect").invoke("disable");
                $("disconnect").enable();
            });

            $("sendForm").observe("submit", function(e) {
                e.stop();
                var textField = $("textField");

                //const file = SelFile[0];

                //console.log(file);

                //const reader = new FileReader();
                //reader.addEventListener('load', (event) => {
                    //img.src = event.target.result;
                //});

                //reader.readAsDataURL(file)

                //if (file!=null) {
                    //console.log(file);
                //}

                while (textField.value.endsWith("\n")) {
                    textField.value=setCharAt(textField.value,textField.value.length-1,"");
                    //textField.value=setCharAt(textField.value,textField.value.length-1,"");
                }
                if (ws&&bool&&!(textField.value==="")) {
                    ws.send("Username\n" + UNS + "\nText\n" + textField.value);
                    log("[You] : " + textField.value + "\n");
                    textField.value = "";
                    textField.focus();
                }
            });

            $("disconnect").observe("click", function(e) {
                e.stop();
                if (ws) {
                    ws.close();
                    ws = null;
                }
            });
        });

        function tif() {

            var months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            var days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
            var d = new Date();
            var day = days[d.getDay()];
            var hr = d.getHours();
            var min = d.getMinutes();
            if (min < 10) {
                min = "0" + min;
            }
            var ampm = "am";
            if( hr > 12 ) {
                hr -= 12;
                ampm = "pm";
            }
            var date = d.getDate();
            var month = months[d.getMonth()];
            var year = d.getFullYear();

            return date + "/" + month + "/" + year;//192.168.1.133:8887

        }
        function setCharAt(str,index,chr) {
            if(index > str.length-1) return str;
            return str.substring(0,index) + chr + str.substring(index+1);
        }

        /*const inputElement = document.getElementById("fc");
        inputElement.addEventListener("change", handleFiles, false);
        function handleFiles() {
            SelFile = this.files; /* now you can work with the file list *\/
        }*/




    </script>
  </head>
  <body onload="losa()">
      <script>
      function losa() {

          console.log("Test");

          var ser = myStorage.getItem('un');

          if (ser==="") {myStorage.setItem('un', 'Username');ser='Username';}

          var usng = document.getElementById('un');usng.value=ser;

      }
      </script>
      <form id="uriForm"><input type="text" id="uri" value="ws://192.168.43.10:8887" style="width:200px;"> <input type="submit" id="connect" value="Connect"><input type="button" id="disconnect" value="Disconnect" disabled="disabled"></form><br>
        <input type="text" id="un" value="Username" style="width:200px;"><br><br>
        <input type="file" id="fc" value="Username" style="width:200px;"><br><br>
      <form id="sendForm"><textarea id="textField" rows="5" cols="50" style="width:400px;"></textarea> <input class="cl" type="submit" value="Send"></form><br>
      <form><textarea disabled id="log" rows="30" cols="100" style="font-family:monospace; color:red;" onload="clicks()"></textarea></form><br>
  </body>
</html>
